package com.benzoft.gravitytubes.files;


import com.benzoft.gravitytubes.GravityTube;
import com.benzoft.gravitytubes.utils.LocationUtil;
import lombok.Getter;
import org.bukkit.Location;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

public final class GravityTubesFile extends AbstractFile {

    private static GravityTubesFile file;
    @Getter
    private List<GravityTube> tubes;

    private GravityTubesFile() {
        super("gravitytubes.yml");
        setDefaults();
    }

    public static GravityTubesFile getInstance() {
        file = file == null ? new GravityTubesFile() : file;
        return file;
    }

    public static void reload() {
        file = new GravityTubesFile();
    }

    @Override
    public void setDefaults() {
        setHeader(
                "This file contains all Gravity Tubes created on your server.",
                "",
                "Do not edit this file manually unless you know exactly what you're doing.",
                ""
        );
        final boolean hasTubes = containsSection("GravityTubes");
        tubes = !hasTubes ? new ArrayList<>() : getConfig().getConfigurationSection("GravityTubes").getKeys(false).stream().map(key -> new GravityTube(LocationUtil.stringToLocation(key), getConfig().getConfigurationSection("GravityTubes." + key))).collect(Collectors.toList());
    }

    public void addTube(final UUID owner, final Location location, final int height, final int power) {
        final String locationsString = LocationUtil.locationToString(location);
        getConfig().set("GravityTubes." + locationsString + ".owner", owner.toString());
        getConfig().set("GravityTubes." + locationsString + ".height", height);
        getConfig().set("GravityTubes." + locationsString + ".power", power);
        getConfig().set("GravityTubes." + locationsString + ".color", "white");
        save();
        tubes.stream().filter(tube -> tube.getSourceLocation().equals(location)).findFirst().ifPresent(tube -> tubes.remove(tube));
        tubes.add(new GravityTube(location, getConfig().getConfigurationSection("GravityTubes." + locationsString)));
    }

    public void removeTube(final GravityTube gravityTube) {
        getConfig().set("GravityTubes." + LocationUtil.locationToString(gravityTube.getSourceLocation()), null);
        save();
        tubes.remove(gravityTube);
    }
}
